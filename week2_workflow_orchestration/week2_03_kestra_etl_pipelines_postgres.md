# Learn Kestra


##  Kestra
- GitHub repo: https://github.com/DataTalksClub/data-engineering-zoomcamp/tree/main/02-workflow-orchestration
- Kestra documentation: https://go.kestra.io/docs
- Kestra has videos such as a 15-minute "Getting Started" video (https://www.youtube.com/watch?v=a2BZ7vOihjg), a tutorial series, and installation guides (such as with Docker Compose) on their YouTube channel: https://www.youtube.com/@kestra-io
- To install, see: https://kestra.io/docs/getting-started/quickstart


## Getting Started
- **Kestra** is an *event-driven* data orchestration platform with an intuitive UI and many optional plugins
- To start, download the Docker image and run it in a Docker container via `winpty docker run --pull=always --rm -it -p 8080:8080 --user=root -v //var/run/docker.sock:/var/run/docker.sock -v /tmp:/tmp kestra/kestra:latest server local`
    - *NOTE*: You need a double forward slash `//` before the local directory of the volume (`-v` argument) for some reason (maybe just on Windows OS?)
- Then, open `http://localhost:8080` in a browser window to launch the Kestra UI and start building **flows**


## Properties
- In Kestra, workflows are known as **flows** and are declared in YAML code
- It also works in a variety of different programming languages
- There are 3 required, key properties of any flow:
    - `id` - The name of the flow
    - `namespace` - The environment of the flow (that you may want to test in, to separate DEV and PROD)
    - `tasks` - These are what your flow executes
        - These have their own properties as well, such as `id`, `type`, `message`, etc.
- Example flow:
    ```yml
    id: getting_started
    namespace: company.team
    tasks:
        - id: hello_world
          type: io.kestra.plugin.core.log.Log
          message: Hello World!
    ```
- Kestra **inputs** are globally-defined values that you can reference throughout a flow
- **Outputs** are generated by some tasks, and they can be used later on in a flow in an additional task
- **Triggers** can set off flows when certain conditions occur (a schedule, a webhook, etc.)


## First flow
- Blog post for this flow example: https://kestra.io/blogs/2024-04-05-getting-started-with-kestra
- We will go through an example flow to execute a Python script (here, an API request to GitHub to see how many stars the Kestra GitHub repo has) once every hour and send the output to a user in Discord
    ```Python
    import requests

    r = requests.get('https://api.github.com/repos/kestra-io/kestra')

    gh_stars = r.json()['stargazers_count']

    print(gh_stars)
    ```
- This will print out in the logs by default, but we can edit this `type` to print out the result via a Python `command` type (good for executing files)
    - Can also use the `scripts` plug-in if just writing a couple of lines of code to keep it all in the YAML for the flow
- On the top-right portion of the UI, click the "Source and Topology" icon to open up the Topology view to the right of the flow's source code, and then click the pencil icon to edit the flow
- For the `type` argument, search for "Python" until you see the `io.kestra.plugin.scripts.python.Commands` type
- Then, add in `python_script` for the `id` argument, `python script.py` for the `commands` argument, and for the `runner` argument, choose "PROCESS"
- Then, save the the task to finish the setup
- Now, we need to actually get our Python script into Kestra
    - On the top of the page, make sure you're on the "Editor" tab
    - Then, expand the "Files" menu via the icon on the top-left of the source code panel to open up the Explorer to the left of the source code
    - Create a new folder/directory, and name it "scripts"
    - Then, within that directory, create your Python file, enter your code into it, and save it
    - Next, in the flow's YAML file, edit the `commands` argument to be `python scripts/<your_script_name>.py`, and then save the flow
        - *You can also just write your scripts locally and sync it to Kestra via git*
    - In order to get this to work (let our task "see" the file), we also must add in a `namespaceFiles` argument with the value `enabled: True`
        ```YML
        id: myflow
        namespace: company.team

        tasks:
            - id: python_script
              type: io.kestra.plugin.scripts.python.Commands
              namespaceFiles:
                enabled: True
              commands:
                - python scripts/<your_script_name>.py
              runner: PROCESS
        ```
    - Lastly, we set up some "Before" commands, which are useful to install dependencies, for example
        - We will set up a virtual environment, install dependencies, and then run our flow
        - First, create a `requirements.txt` file in the `scripts/` directory, and enter `requests` into it
        - Then, add the `beforeCommands` to the flow YAML:
        ```YML
        id: myflow
        namespace: company.team

        tasks:
            - id: python_script
              type: io.kestra.plugin.scripts.python.Commands
              namespaceFiles:
                enabled: True
              beforeCommands:
                - python3 -m venv .venv
                - . .venv/bin/activate
                - pip install -r scripts/requirements.txt
              commands:
                - python scripts/<your_script_name>.py
              runner: PROCESS
        ```
    - Once everything is saved, we can click "Execute" on the top-right of the UI
    - You can then review the logs to see everything running successfully (installing Python packages, printing out results, etc.)


## Using Outputs
- Now, we will get the outputs of the Python file above and pass them onto later tasks within the workflow
- We being by editing the Python file to send back the value we just printed as a variable
    - First, add the `kestra` library to `requirements.txt` and then add its respective `import` statement to the Python file
    - Then, use the `kestra` library to make our value available to the Kestra platform as an output via a Python dictionary:
        ```Python
        import requests
        from kestra import Kestra

        r = requests.get('https://api.github.com/repos/kestra-io/kestra')

        gh_stars = r.json()['stargazers_count']

        # print(gh_stars)

        # Make the output available in the Kestra platform
        Kestra.outputs({'gh_stars': gh_stars})    
        ```
    - Then, we add a new log task to the flow to log things separately to the Python output, to make things a little bit more clear:
    ```YML
        id: myflow
        namespace: company.team

        tasks:
        - id: python_script
          type: io.kestra.plugin.scripts.python.Commands
          namespaceFiles:
          enabled: True
          runner: PROCESS
          beforeCommands:
            - python3 -m venv .venv
            - . .venv/bin/activate
            - pip install -r scripts/requirements.txt
          commands:
            - python scripts/<your_script_name>.py
        
        - id: output_gh_stars
          type: io.kestra.plugin.core.log.Log
          # Reference output via outputs.<task_id>.vars.<variable_name>
          message: 'Number of stars: {{ outputs.python_script.vars.gh_stars }}'
    ```
    - Once executed, you can see that the output was printed out separately to the *log* window of the "Logs" tab in Kestra, rather than in the "python_script" task window (where we can still see executions like the Python package installations)


## Adding a Notification
- Now, we will set up a Discord notification that is sent out every time this flow executes
- Using either the "+" icon in the Topology view in the UI or via YAML, add in a Discord Execution `type` task and name it (the `id` argument) `send_notification`
- Then, for the `content` argument, enter `Total number of GitHub stars: {{ outputs.python_script.vars.gh_stars }}`
- We also need a webhook URL for the `url` argument, which we get from Discord, but for now just input `https://example.com`
- You can then give the `username` argument a value of `kestra` so that the Discord message will have a name attached to it
- Optionally, you can get the Kestra organization profile picture URL from the Kestra GitHub to enter as the `avatarUrl` argument
    ```YML
    - id: send_notification
    type: io.kestra.plugin.notifications.discord.DiscordExecution
    avatarUrl: https://avatars.githubusercontent.com/u/59033362?s=200&v=4
    content: "Total number of GitHub stars: {{ outputs.python_script.vars.gh_stars }}"
    url: https://example.com
    username: Kestra
    ```
- We can also use Kestra **Inputs** to globally-define values and reference them within the YAML:
    ```YML
    inputs:
        - id: kestra_logo
        type: STRING
        defaults: https://avatars.githubusercontent.com/u/59033362?s=200&v=4

    tasks:
        - id: send_notification
        type: io.kestra.plugin.notifications.discord.DiscordExecution
        avatarUrl: "{{ inputs.kestra_logo }}"
        content: "Total number of GitHub stars: {{ outputs.python_script.vars.gh_stars }}"
        url: https://example.com
        username: Kestra      
    ```
- Finally, to get the webhook URL from Discord, first go to a personal server/a server that you own
    - Then, right-click on any channel, and click the "Edit Channel" property
    - Go the "Integrations" section, and click "Create Webhook"
    - The details that then show up in the Discord UI, aren't that important, since Kestra will end up defining these for us
        - But for now, you can name it `kestra` and add its profile picture if desired
    - Then, click "Copy Webhook URL" and add it to the YML for the flow *as an input*
    ```YML
    inputs:
    - id: kestra_logo
      type: STRING
      defaults: https://avatars.githubusercontent.com/u/59033362?s=200&v=4
    
    - id: discord_webhook
      type: STRING
      defaults: <your_webhook_url>

    - id: send_notification
      type: io.kestra.plugin.notifications.discord.DiscordExecution
      avatarUrl: "{{ inputs.kestra_logo }}" 
      content: "Total number of GitHub stars: {{ outputs.python_script.vars.gh_stars }}"
      url: "{{ inputs.discord_webhook }}" 
      username: Kestra
    ```
- Now, when we execute the flow, we will see *three* sections in the "Logs" tab, one for each task