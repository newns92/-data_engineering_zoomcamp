# Learn Kestra


##  Kestra
- GitHub repo: https://github.com/DataTalksClub/data-engineering-zoomcamp/tree/main/02-workflow-orchestration
- Kestra documentation: https://go.kestra.io/docs
- Kestra has videos such as a 15-minute "Getting Started" video (https://www.youtube.com/watch?v=a2BZ7vOihjg), a tutorial series, and installation guides (such as with Docker Compose) on their YouTube channel: https://www.youtube.com/@kestra-io
- To install, see: https://kestra.io/docs/getting-started/quickstart


## Getting Started
- **Kestra** is an *event-driven* data orchestration platform with an intuitive UI and many optional plugins
- To start, download the Docker image and run it in a Docker container via `winpty docker run --pull=always --rm -it -p 8080:8080 --user=root -v //var/run/docker.sock:/var/run/docker.sock -v /tmp:/tmp kestra/kestra:latest server local`
    - *NOTE*: You need a double forward slash `//` before the local directory of the volume (`-v` argument) for some reason (maybe just on Windows OS?)
- Then, open `http://localhost:8080` in a browser window to launch the Kestra UI and start building **flows**


## Properties
- In Kestra, workflows are known as **flows** and are declared in YAML code
- It also works in a variety of different programming languages
- There are 3 required, key properties of any flow:
    - `id` - The name of the flow
    - `namespace` - The environment of the flow (that you may want to test in, to separate DEV and PROD)
    - `tasks` - These are what your flow executes
        - These have their own properties as well, such as `id`, `type`, `message`, etc.
- Example flow:
    ```yml
    id: getting_started
    namespace: company.team
    tasks:
        - id: hello_world
            type: io.kestra.plugin.core.log.Log
            message: Hello World!
    ```
- Kestra **inputs** are globally-defined values that you can reference throughout a flow
- **Outputs** are generated by some tasks, and they can be used later on in a flow in an additional task
- **Triggers** can set off flows when certain conditions occur (a schedule, a webhook, etc.)


## First flow
- Blog post for this flow example: https://kestra.io/blogs/2024-04-05-getting-started-with-kestra
- We will go through an example flow to execute a Python script (here, an API request to GitHub to see how many stars the Kestra GitHub repo has) once every hour and send the output to a user in Discord
    ```Python
    import requests

    r = requests.get('https://api.github.com/repos/kestra-io/kestra')

    gh_stars = r.json(['stargazers_count'])

    print(gh_stars)
    ```
- This will print out in the logs by default, but we can edit this `type` to print out the result via a Python `command` type (good for executing files)
    - Can also use the `scripts` plug-in if just writing a couple of lines of code to keep it all in the YAML for the flow
- On the top-right portion of the UI, click the "Source and Topology" icon to open up the Topology view to the right of the flow's source code, and then click the pencil icon to edit the flow
- For the `type` argument, search for "Python" until you see the `io.kestra.plugin.scripts.python.Commands` type
- Then, add in `python_script` for the `id` argument, `python script.py` for the `commands` argument, and for the `runner` argument, choose "PROCESS"
- Then, save the the task to finish the setup
- Now, we need to actually get our Python script into Kestra
    - On the top of the page, make sure you're on the "Editor" tab
    - Then, expand the "Files" menu via the icon on the top-left of the source code panel to open up the Explorer to the left of the source code
    - Create a new folder/directory, and name it "scripts"
    - Then, within that directory, create your Python file, enter your code into it, and save it
    - Next, in the flow's YAML file, edit the `commands` argument to be `python scripts/<your_script_name>.py`, and then save the flow
        - *You can also just write your scripts locally and sync it to Kestra via git*
    - In order to get this to work (let our task "see" the file), we also must add in a `namespaceFiles` argument with the value `enabled: True`
        ```YML
        id: myflow
        namespace: company.team

        tasks:
            - id: python_script
            type: io.kestra.plugin.scripts.python.Commands
            namespaceFiles:
                enabled: True
            commands:
                - python <your_script_name>.py
            runner: PROCESS
        ```
    - Lastly, we set up some "Before" commands, which are useful to install dependencies, for example
        - We will set up a virtual environment, install dependencies, and then run our flow
        - First, create a `requirements.txt` file in the `scripts/` directory, and enter `requests` into it
        - Then, add the `beforeCommands` to the flow YAML:
        ```YML
        id: myflow
        namespace: company.team

        tasks:
            - id: python_script
            type: io.kestra.plugin.scripts.python.Commands
            namespaceFiles:
                enabled: True
            beforeCommands:
                - python3 -m venv .venv
                - . .venv/bin/activate
                - pip install -r scripts/requirements.txt
            commands:
                - python <your_script_name>.py
            runner: PROCESS
        ```
    - Once everything is saved, we can click "Execute" on the top-right of the UI
    